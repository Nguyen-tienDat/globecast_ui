<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç GlobeCast - Real-time Speech Translation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
            font-weight: 300;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected { background: #4CAF50; }
        .status-disconnected { background: #f44336; }
        .status-processing { background: #ff9800; }
        .status-listening { background: #2196F3; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .main-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .control-panel h3 {
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn.recording {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            animation: recording-pulse 1s infinite;
        }

        .btn.primary { background: linear-gradient(45deg, #4834d4, #686de0); }
        .btn.success { background: linear-gradient(45deg, #00d2d3, #54a0ff); }
        .btn.danger { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }

        @keyframes recording-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .language-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 12px 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .language-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .language-btn.active {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            border-color: rgba(255,255,255,0.6);
            transform: scale(1.05);
        }

        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .result-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 350px;
            position: relative;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .result-header h3 {
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-badge {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .confidence-bar {
            background: rgba(255,255,255,0.2);
            height: 6px;
            border-radius: 3px;
            margin: 10px 0 20px 0;
            overflow: hidden;
            position: relative;
        }

        .confidence-fill {
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .confidence-text {
            position: absolute;
            right: 0;
            top: -25px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0.8;
        }

        .result-content {
            background: rgba(0,0,0,0.3);
            padding: 25px;
            border-radius: 15px;
            min-height: 200px;
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.7;
            font-size: 16px;
            position: relative;
            word-wrap: break-word;
        }

        .result-content.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
            font-style: italic;
        }

        .result-content.processing::after {
            content: '';
            position: absolute;
            bottom: 10px;
            right: 15px;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .audio-controls {
            margin-bottom: 20px;
        }

        .file-upload {
            position: relative;
            display: block;
            margin-bottom: 15px;
        }

        .file-upload input {
            display: none;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-upload-label:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .file-info {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .logs-panel {
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }

        .log-entry:hover {
            background: rgba(255,255,255,0.1);
        }

        .log-info {
            background: rgba(33, 150, 243, 0.2);
            border-left-color: #2196F3;
        }
        .log-success {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #4CAF50;
        }
        .log-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left-color: #FF9800;
        }
        .log-error {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #F44336;
        }

        .stats-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (max-width: 768px) {
            .results-section {
                grid-template-columns: 1fr;
            }

            .main-controls {
                grid-template-columns: 1fr;
            }

            .language-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }
        }

        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üåç GlobeCast</h1>
        <p>Real-time Speech Recognition & Translation</p>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-indicator status-disconnected" id="connectionStatus"></span>
            <span id="connectionText">Connecting...</span>
        </div>
        <div class="status-item">
            <span class="status-indicator status-disconnected" id="micStatus"></span>
            <span id="micText">Microphone Ready</span>
        </div>
        <div class="status-item">
            <span class="status-indicator status-disconnected" id="serverStatus"></span>
            <span id="serverText">Server Status</span>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-value" id="transcriptionsCount">0</div>
            <div class="stat-label">Transcriptions</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="translationsCount">0</div>
            <div class="stat-label">Translations</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="sessionTime">00:00</div>
            <div class="stat-label">Session Time</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgConfidence">0%</div>
            <div class="stat-label">Avg Confidence</div>
        </div>
    </div>

    <div class="main-controls">
        <div class="control-panel">
            <h3>üéôÔ∏è Audio Input</h3>
            <button class="btn primary" id="recordBtn">
                <span>üéôÔ∏è</span> Start Listening
            </button>
            <div class="file-upload">
                <input type="file" id="audioFile" accept="audio/*">
                <label for="audioFile" class="file-upload-label">
                    <span>üìÅ</span> Upload Audio File
                </label>
            </div>
            <div id="fileInfo" class="file-info hidden"></div>
        </div>

        <div class="control-panel">
            <h3>üåê Translation Settings</h3>
            <div class="language-grid">
                <button class="language-btn active" data-lang="en">üá∫üá∏ English</button>
                <button class="language-btn" data-lang="vi">üáªüá≥ Ti·∫øng Vi·ªát</button>
                <button class="language-btn" data-lang="zh">üá®üá≥ ‰∏≠Êñá</button>
                <button class="language-btn" data-lang="ja">üáØüáµ Êó•Êú¨Ë™û</button>
                <button class="language-btn" data-lang="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</button>
                <button class="language-btn" data-lang="fr">üá´üá∑ Fran√ßais</button>
                <button class="language-btn" data-lang="de">üá©üá™ Deutsch</button>
                <button class="language-btn" data-lang="es">üá™üá∏ Espa√±ol</button>
            </div>
            <p style="margin-top: 15px; opacity: 0.8; font-size: 14px;">
                <strong>Target:</strong> <span id="selectedLangDisplay">English</span>
            </p>
        </div>

        <div class="control-panel">
            <h3>‚öôÔ∏è Controls</h3>
            <button class="btn success" id="testBtn">
                <span>üì®</span> Test Connection
            </button>
            <button class="btn" id="clearBtn">
                <span>üóëÔ∏è</span> Clear Results
            </button>
            <button class="btn danger" id="stopBtn">
                <span>‚èπÔ∏è</span> Stop All
            </button>
        </div>
    </div>

    <div class="results-section">
        <div class="result-panel fade-in">
            <div class="result-header">
                <h3>üìù Original Speech</h3>
                <span class="language-badge" id="originalLangBadge">DETECTING</span>
            </div>
            <div class="confidence-bar">
                <div class="confidence-fill" id="originalConfidence" style="width: 0%"></div>
                <div class="confidence-text" id="originalConfidenceText">0%</div>
            </div>
            <div class="result-content empty" id="transcriptionResult">
                üé§ Start speaking or upload an audio file to see transcription here...
            </div>
        </div>

        <div class="result-panel fade-in">
            <div class="result-header">
                <h3>üåç Translation</h3>
                <span class="language-badge" id="translationLangBadge">TARGET</span>
            </div>
            <div class="confidence-bar">
                <div class="confidence-fill" id="translationConfidence" style="width: 0%"></div>
                <div class="confidence-text" id="translationConfidenceText">0%</div>
            </div>
            <div class="result-content empty" id="translationResult">
                üåê Translations will appear here automatically...
            </div>
        </div>
    </div>

    <div class="logs-panel">
        <div class="logs-header">
            <h3>üìä Activity Logs</h3>
            <button class="btn" id="clearLogsBtn" style="padding: 8px 15px; font-size: 14px;">
                Clear Logs
            </button>
        </div>
        <div id="logContainer"></div>
    </div>
</div>

<script>
    class GlobeCastClient {
        constructor() {
            this.ws = null;
            this.isRecording = false;
            this.mediaRecorder = null;
            this.audioChunks = [];
            this.selectedTargetLang = 'en';
            this.startTime = Date.now();
            this.connectedPort = null; // Track successful connection port
            this.stats = {
                transcriptions: 0,
                translations: 0,
                totalConfidence: 0,
                sessionStart: Date.now()
            };

            this.initializeElements();
            this.setupEventListeners();
            this.connect();
            this.startSessionTimer();
        }

        initializeElements() {
            this.elements = {
                // Status indicators
                connectionStatus: document.getElementById('connectionStatus'),
                connectionText: document.getElementById('connectionText'),
                micStatus: document.getElementById('micStatus'),
                micText: document.getElementById('micText'),
                serverStatus: document.getElementById('serverStatus'),
                serverText: document.getElementById('serverText'),

                // Controls
                recordBtn: document.getElementById('recordBtn'),
                testBtn: document.getElementById('testBtn'),
                clearBtn: document.getElementById('clearBtn'),
                stopBtn: document.getElementById('stopBtn'),
                audioFile: document.getElementById('audioFile'),
                fileInfo: document.getElementById('fileInfo'),

                // Language selection
                selectedLangDisplay: document.getElementById('selectedLangDisplay'),

                // Results
                transcriptionResult: document.getElementById('transcriptionResult'),
                translationResult: document.getElementById('translationResult'),
                originalLangBadge: document.getElementById('originalLangBadge'),
                translationLangBadge: document.getElementById('translationLangBadge'),
                originalConfidence: document.getElementById('originalConfidence'),
                translationConfidence: document.getElementById('translationConfidence'),
                originalConfidenceText: document.getElementById('originalConfidenceText'),
                translationConfidenceText: document.getElementById('translationConfidenceText'),

                // Stats
                transcriptionsCount: document.getElementById('transcriptionsCount'),
                translationsCount: document.getElementById('translationsCount'),
                sessionTime: document.getElementById('sessionTime'),
                avgConfidence: document.getElementById('avgConfidence'),

                // Logs
                logContainer: document.getElementById('logContainer'),
                clearLogsBtn: document.getElementById('clearLogsBtn')
            };
        }

        setupEventListeners() {
            // Audio controls
            this.elements.recordBtn.addEventListener('click', () => this.toggleRecording());
            this.elements.audioFile.addEventListener('change', (e) => this.handleFileUpload(e));

            // Action buttons
            this.elements.testBtn.addEventListener('click', () => this.sendTestMessage());
            this.elements.clearBtn.addEventListener('click', () => this.clearResults());
            this.elements.stopBtn.addEventListener('click', () => this.stopAll());
            this.elements.clearLogsBtn.addEventListener('click', () => this.clearLogs());

            // Language selection
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('language-btn')) {
                    this.selectLanguage(e.target);
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && e.ctrlKey) {
                    e.preventDefault();
                    this.toggleRecording();
                }
                if (e.code === 'KeyT' && e.ctrlKey) {
                    e.preventDefault();
                    this.sendTestMessage();
                }
            });
        }

        selectLanguage(button) {
            // Remove active class from all buttons
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to selected button
            button.classList.add('active');

            this.selectedTargetLang = button.dataset.lang;
            this.elements.selectedLangDisplay.textContent = button.textContent;
            this.elements.translationLangBadge.textContent = this.selectedTargetLang.toUpperCase();

            this.log(`üåê Target language changed to: ${button.textContent}`, 'info');
        }

        connect() {
            this.updateConnectionStatus('connecting', 'Connecting...');

            try {
                // Try multiple ports
                const ports = [8766, 8080, 8000];
                this.tryConnect(ports, 0);
            } catch (error) {
                this.log(`‚ùå Connection failed: ${error.message}`, 'error');
                this.updateConnectionStatus('disconnected', 'Connection Failed');
            }
        }

        tryConnect(ports, index) {
            if (index >= ports.length) {
                this.log(`‚ùå All standard ports failed. Checking server logs for actual port...`, 'error');
                this.updateConnectionStatus('disconnected', 'Checking server logs...');
                // Try to scan common dynamic ports
                this.scanDynamicPorts();
                return;
            }

            const port = ports[index];
            this.log(`üîÑ Trying connection to ws://127.0.0.1:${port}`, 'info');

            try {
                this.ws = new WebSocket(`ws://127.0.0.1:${port}`);

                // Set timeout for connection attempt
                const connectTimeout = setTimeout(() => {
                    if (this.ws.readyState === WebSocket.CONNECTING) {
                        this.ws.close();
                        this.log(`‚è∞ Connection timeout on port ${port}`, 'warning');
                        this.tryConnect(ports, index + 1);
                    }
                }, 3000);

                this.ws.onopen = () => {
                    clearTimeout(connectTimeout);
                    this.updateConnectionStatus('connected', `Connected (Port ${port})`);
                    this.updateServerStatus('connected', 'Server Online');
                    this.log(`‚úÖ Connected to GlobeCast server on port ${port}`, 'success');
                    this.connectedPort = port; // Store successful port
                };

                this.ws.onmessage = (event) => {
                    this.handleMessage(JSON.parse(event.data));
                };

                this.ws.onclose = (event) => {
                    clearTimeout(connectTimeout);
                    if (event.wasClean) {
                        this.log(`üì¥ Connection closed cleanly`, 'warning');
                    } else {
                        this.log(`üì¥ Connection lost (Code: ${event.code})`, 'warning');
                    }
                    this.updateConnectionStatus('disconnected', 'Disconnected');
                    this.updateServerStatus('disconnected', 'Server Offline');

                    // If we were connected before, try to reconnect to the same port first
                    if (this.connectedPort && event.code !== 1006) {
                        setTimeout(() => this.reconnectToPort(this.connectedPort), 2000);
                    } else {
                        setTimeout(() => this.connect(), 3000);
                    }
                };

                this.ws.onerror = (error) => {
                    clearTimeout(connectTimeout);
                    this.log(`‚ùå WebSocket error on port ${port}`, 'error');
                    // Try next port after a short delay
                    setTimeout(() => this.tryConnect(ports, index + 1), 500);
                };

            } catch (error) {
                this.log(`‚ùå Failed to create WebSocket on port ${port}: ${error.message}`, 'error');
                this.tryConnect(ports, index + 1);
            }
        }

        scanDynamicPorts() {
            // Scan some common dynamic ports that server might use
            const dynamicPorts = [3000, 5000, 8001, 8002, 8765, 9000];
            this.log(`üîç Scanning dynamic ports: ${dynamicPorts.join(', ')}`, 'info');
            this.tryConnect(dynamicPorts, 0);
        }

        reconnectToPort(port) {
            this.log(`üîÑ Attempting to reconnect to port ${port}`, 'info');
            try {
                this.ws = new WebSocket(`ws://127.0.0.1:${port}`);

                this.ws.onopen = () => {
                    this.updateConnectionStatus('connected', `Reconnected (Port ${port})`);
                    this.updateServerStatus('connected', 'Server Online');
                    this.log(`‚úÖ Reconnected to GlobeCast server on port ${port}`, 'success');
                };

                this.ws.onmessage = (event) => {
                    this.handleMessage(JSON.parse(event.data));
                };

                this.ws.onclose = (event) => {
                    this.updateConnectionStatus('disconnected', 'Disconnected');
                    this.updateServerStatus('disconnected', 'Server Offline');
                    // Fall back to full connection scan
                    setTimeout(() => this.connect(), 3000);
                };

                this.ws.onerror = (error) => {
                    this.log(`‚ùå Reconnection failed on port ${port}`, 'error');
                    // Fall back to full connection scan
                    setTimeout(() => this.connect(), 3000);
                };

            } catch (error) {
                this.log(`‚ùå Reconnection error: ${error.message}`, 'error');
                setTimeout(() => this.connect(), 3000);
            }
        }

        handleMessage(data) {
            this.log(`üì® Received: ${data.type}`, 'info');

            switch (data.type) {
                case 'connection':
                    this.handleConnectionMessage(data);
                    break;
                case 'transcription':
                    this.handleTranscriptionResult(data);
                    break;
                case 'translation_result':
                    this.handleDirectTranslation(data);
                    break;
                case 'test_response':
                    this.log(`üì® Test successful: ${data.message}`, 'success');
                    break;
                case 'error':
                    this.log(`‚ùå Server error: ${data.message}`, 'error');
                    break;
                default:
                    this.log(`üì® Unknown message type: ${data.type}`, 'warning');
            }
        }

        handleConnectionMessage(data) {
            this.log(`ü§ù ${data.message}`, 'success');
            if (data.capabilities) {
                this.updateServerStatus('connected', `Whisper: ${data.capabilities.whisper}`);
                this.log(`üéØ Capabilities - Whisper: ${data.capabilities.whisper}, Translation: ${data.capabilities.translation}`, 'info');
            }
        }

        handleTranscriptionResult(data) {
            // Update transcription
            this.elements.transcriptionResult.textContent = data.text;
            this.elements.transcriptionResult.classList.remove('empty', 'processing');

            // Update language badge
            this.elements.originalLangBadge.textContent = data.language.toUpperCase();

            // Update confidence
            const confidence = Math.max(0, Math.min(100, (data.confidence + 1) * 50));
            this.updateConfidence('original', confidence);

            // Update stats
            this.stats.transcriptions++;
            this.stats.totalConfidence += confidence;
            this.updateStats();

            this.log(`üìù Transcription (${data.language}): ${data.text.substring(0, 50)}...`, 'success');

            // Handle translation
            if (data.translation) {
                this.displayTranslation(data.translation.text, data.translation.language, data.translation.confidence * 100);
            } else if (this.selectedTargetLang !== data.language) {
                this.requestTranslation(data.text);
            }
        }

        handleDirectTranslation(data) {
            this.displayTranslation(data.translated_text, data.target_language, data.confidence * 100);
            this.log(`üåç Translation completed`, 'success');
        }

        displayTranslation(text, language, confidence) {
            this.elements.translationResult.textContent = text;
            this.elements.translationResult.classList.remove('empty', 'processing');
            this.elements.translationLangBadge.textContent = language.toUpperCase();

            this.updateConfidence('translation', confidence);

            this.stats.translations++;
            this.updateStats();

            this.log(`üåç Translation (${language}): ${text.substring(0, 50)}...`, 'success');
        }

        requestTranslation(text) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.elements.translationResult.textContent = 'Translating...';
                this.elements.translationResult.classList.add('processing');
                this.elements.translationResult.classList.remove('empty');

                const message = {
                    type: 'translate_request',
                    text: text,
                    target_lang: this.selectedTargetLang
                };

                this.ws.send(JSON.stringify(message));
                this.log(`üåç Requesting translation to ${this.selectedTargetLang}`, 'info');
            }
        }

        async toggleRecording() {
            if (!this.isRecording) {
                await this.startRecording();
            } else {
                this.stopRecording();
            }
        }

        async startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });

                this.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                this.audioChunks = [];

                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.audioChunks.push(event.data);
                    }
                };

                this.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                    this.sendAudioData(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                this.mediaRecorder.start();
                this.isRecording = true;

                // Update UI
                this.elements.recordBtn.innerHTML = '<span>‚èπÔ∏è</span> Stop Listening';
                this.elements.recordBtn.classList.add('recording');
                this.updateMicStatus('listening', 'Recording...');

                // Clear previous results
                this.elements.transcriptionResult.textContent = 'Listening...';
                this.elements.transcriptionResult.classList.add('processing');
                this.elements.transcriptionResult.classList.remove('empty');

                this.log('üéôÔ∏è Recording started', 'info');

            } catch (error) {
                this.log(`‚ùå Failed to start recording: ${error.message}`, 'error');
                this.updateMicStatus('disconnected', 'Mic Error');
            }
        }

        stopRecording() {
            if (this.mediaRecorder && this.isRecording) {
                this.mediaRecorder.stop();
                this.isRecording = false;

                // Update UI
                this.elements.recordBtn.innerHTML = '<span>üéôÔ∏è</span> Start Listening';
                this.elements.recordBtn.classList.remove('recording');
                this.updateMicStatus('connected', 'Ready');

                this.log('‚èπÔ∏è Recording stopped', 'info');
            }
        }

        handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);

                this.elements.fileInfo.innerHTML = `
                    <strong>üìÅ File:</strong> ${file.name}<br>
                    <strong>üìä Size:</strong> ${fileSize} MB<br>
                    <strong>üéµ Type:</strong> ${file.type}
                `;
                this.elements.fileInfo.classList.remove('hidden');

                this.log(`üìÅ File selected: ${file.name} (${fileSize} MB)`, 'info');
                this.sendAudioData(file);
            }
        }

        async sendAudioData(audioData) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                try {
                    this.updateConnectionStatus('processing', 'Processing...');
                    this.log(`üéµ Sending audio: ${(audioData.size / 1024).toFixed(0)} KB`, 'info');

                    const arrayBuffer = await audioData.arrayBuffer();
                    this.ws.send(arrayBuffer);

                    this.log('‚úÖ Audio sent successfully', 'success');

                } catch (error) {
                    this.log(`‚ùå Failed to send audio: ${error.message}`, 'error');
                }
            } else {
                this.log('‚ùå WebSocket not connected', 'error');
            }
        }

        sendTestMessage() {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'test',
                    message: 'Test message from GlobeCast client',
                    timestamp: new Date().toISOString(),
                    target_lang: this.selectedTargetLang
                };

                this.ws.send(JSON.stringify(testMessage));
                this.log('üì® Test message sent', 'info');
            } else {
                this.log('‚ùå Cannot send test - not connected', 'error');
            }
        }

        stopAll() {
            if (this.isRecording) {
                this.stopRecording();
            }

            if (this.ws) {
                this.ws.close();
            }

            this.log('üõë All operations stopped', 'warning');
        }

        clearResults() {
            this.elements.transcriptionResult.textContent = 'üé§ Start speaking or upload an audio file to see transcription here...';
            this.elements.transcriptionResult.classList.add('empty');
            this.elements.transcriptionResult.classList.remove('processing');

            this.elements.translationResult.textContent = 'üåê Translations will appear here automatically...';
            this.elements.translationResult.classList.add('empty');
            this.elements.translationResult.classList.remove('processing');

            this.elements.originalLangBadge.textContent = 'DETECTING';
            this.elements.translationLangBadge.textContent = this.selectedTargetLang.toUpperCase();

            this.updateConfidence('original', 0);
            this.updateConfidence('translation', 0);

            this.elements.fileInfo.classList.add('hidden');

            this.log('üóëÔ∏è Results cleared', 'info');
        }

        clearLogs() {
            this.elements.logContainer.innerHTML = '';
        }

        updateConnectionStatus(status, text) {
            this.elements.connectionStatus.className = `status-indicator status-${status}`;
            this.elements.connectionText.textContent = text;
        }

        updateMicStatus(status, text) {
            this.elements.micStatus.className = `status-indicator status-${status}`;
            this.elements.micText.textContent = text;
        }

        updateServerStatus(status, text) {
            this.elements.serverStatus.className = `status-indicator status-${status}`;
            this.elements.serverText.textContent = text;
        }

        updateConfidence(type, percentage) {
            const fillElement = this.elements[`${type}Confidence`];
            const textElement = this.elements[`${type}ConfidenceText`];

            fillElement.style.width = `${percentage}%`;
            textElement.textContent = `${Math.round(percentage)}%`;
        }

        updateStats() {
            this.elements.transcriptionsCount.textContent = this.stats.transcriptions;
            this.elements.translationsCount.textContent = this.stats.translations;

            const avgConfidence = this.stats.transcriptions > 0
                ? Math.round(this.stats.totalConfidence / this.stats.transcriptions)
                : 0;
            this.elements.avgConfidence.textContent = `${avgConfidence}%`;
        }

        startSessionTimer() {
            setInterval(() => {
                const elapsed = Date.now() - this.stats.sessionStart;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                this.elements.sessionTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;

            this.elements.logContainer.appendChild(logEntry);
            this.elements.logContainer.scrollTop = this.elements.logContainer.scrollHeight;

            // Keep only last 100 log entries
            const entries = this.elements.logContainer.children;
            if (entries.length > 100) {
                this.elements.logContainer.removeChild(entries[0]);
            }
        }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
        new GlobeCastClient();

        // Add keyboard shortcuts info to console
        console.log('üéØ GlobeCast Keyboard Shortcuts:');
        console.log('   Ctrl + Space: Toggle Recording');
        console.log('   Ctrl + T: Send Test Message');
    });
</script>
</body>
</html>